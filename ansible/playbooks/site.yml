---
# =============================================================================
# SITE PLAYBOOK - Master playbook to configure all infrastructure
# =============================================================================
#
# Usage:
#   ansible-playbook playbooks/site.yml
#   ansible-playbook playbooks/site.yml --tags "common"
#   ansible-playbook playbooks/site.yml --limit "zeppelin"
#
# =============================================================================

- name: Load global variables
  hosts: all
  gather_facts: false
  tasks:
    - name: Include global variables
      include_vars: ../variables/main.yml
    - name: Include secrets
      include_vars: ../variables/secrets.yml

# -----------------------------------------------------------------------------
# Phase 1: Common setup for all instances
# -----------------------------------------------------------------------------
- import_playbook: common.yml

# -----------------------------------------------------------------------------
# Phase 2: Configure Zeppelin (public subnet)
# -----------------------------------------------------------------------------
- import_playbook: zeppelin.yml

# -----------------------------------------------------------------------------
# Phase 3: Configure Spark (private subnet)
# -----------------------------------------------------------------------------
- import_playbook: spark.yml

# -----------------------------------------------------------------------------
# Phase 4: Configure Neo4j (private subnet)
# -----------------------------------------------------------------------------
- import_playbook: neo4j.yml

# -----------------------------------------------------------------------------
# Phase 5: Post-configuration verification
# -----------------------------------------------------------------------------
- name: Verify all services
  hosts: all
  gather_facts: true
  vars_files:
    - ../variables/main.yml
  tasks:
    - name: Wait for services to stabilize
      pause:
        seconds: 30
      run_once: true

    - name: Verify Zeppelin is running
      uri:
        url: "http://{{ zeppelin_host }}:{{ zeppelin_port }}"
        method: GET
        status_code: 200
      when: "'zeppelin' in group_names"
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: Verify Spark Master is running
      uri:
        url: "http://{{ spark_master_host }}:{{ spark_master_webui_port }}"
        method: GET
        status_code: 200
      when: "'spark' in group_names"
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: Verify Neo4j is running
      uri:
        url: "http://{{ neo4j_host }}:{{ neo4j_http_port }}"
        method: GET
        status_code: 200
      when: "'neo4j' in group_names"
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: Print completion message
      debug:
        msg: |
          =====================================================
          ðŸŽ‰ Infrastructure Configuration Complete!
          =====================================================
          Zeppelin: http://{{ zeppelin_host }}:{{ zeppelin_port }}
          Spark Master: http://{{ spark_master_host }}:{{ spark_master_webui_port }}
          Neo4j Browser: http://{{ neo4j_host }}:{{ neo4j_http_port }}
          Neo4j Bolt: bolt://{{ neo4j_host }}:{{ neo4j_bolt_port }}
          =====================================================
      run_once: true
